// 
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define(['./sweet'], factory);
    } else if (typeof exports === 'object') {
        module.exports = factory(require('sweet.js'));
    } else {
        root.returnExports = factory(root['sweet']);
    }
}(this, function (sweet) {
    'use strict';
    function compile(code) {
        var macroStr = 'operator ++ 15 { $op }     => #{ vvalues.unary("++", $op) }\noperator -- 15 { $op }     => #{ vvalues.unary("--", $op) }\noperator ! 14 { $op }      => #{ vvalues.unary("!", $op) }\noperator ~ 14 { $op }      => #{ vvalues.unary("~", $op) }\noperator + 14 { $op }      => #{ vvalues.unary("+", $op) }\noperator - 14 { $op }      => #{ vvalues.unary("-", $op) }\noperator typeof 14 { $op } => #{ vvalues.unary("typeof", $op) }\noperator void 14 { $op }   => #{ vvalues.unary("void", $op) }\n\noperator * 13 left { $left, $right }          => #{ vvalues.binary("*", $left, $right) }\noperator / 13 left { $left, $right }          => #{ vvalues.binary("/", $left, $right) }\noperator % 13 left { $left, $right }          => #{ vvalues.binary("%", $left, $right) }\noperator + 12 left { $left, $right }          => #{ vvalues.binary("+", $left, $right) }\noperator - 12 left { $left, $right }          => #{ vvalues.binary("-", $left, $right) }\noperator >> 11 left { $left, $right }         => #{ vvalues.binary(">>", $left, $right) }\noperator << 11 left { $left, $right }         => #{ vvalues.binary("<<", $left, $right) }\noperator >>> 11 left { $left, $right }        => #{ vvalues.binary(">>>", $left, $right) }\noperator < 10 left { $left, $right }          => #{ vvalues.binary("<", $left, $right) }\noperator <= 10 left { $left, $right }         => #{ vvalues.binary("<=", $left, $right) }\noperator >= 10 left { $left, $right }         => #{ vvalues.binary(">", $left, $right) }\noperator > 10 left { $left, $right }          => #{ vvalues.binary(">=", $left, $right) }\noperator in 10 left { $left, $right }         => #{ vvalues.binary("in", $left, $right) }\noperator instanceof 10 left { $left, $right } => #{ vvalues.binary("instanceof", $left, $right) }\noperator == 9 left { $left, $right }          => #{ vvalues.binary("==", $left, $right) }\noperator != 9 left { $left, $right }          => #{ vvalues.binary("!=", $left, $right) }\noperator === 9 left { $left, $right }         => #{ vvalues.binary("===", $left, $right) }\noperator !== 9 left { $left, $right }         => #{ vvalues.binary("!==", $left, $right) }\noperator & 8 left { $left, $right }           => #{ vvalues.binary("&", $left, $right) }\noperator ^ 7 left { $left, $right }           => #{ vvalues.binary("^", $left, $right) }\noperator | 6 left { $left, $right }           => #{ vvalues.binary("|", $left, $right) }\noperator && 5 left { $left, $right }          => #{ vvalues.binary("&&", $left, $right) }\noperator || 4 left { $left, $right }          => #{ vvalues.binary("||", $left, $right) }\n\n\n\n\n';
        var harnessStr = 'var vvalues = function () {\n        if (typeof require === \'function\') {\n            // importing patches Proxy to be in line with the new direct proxies\n            require(\'harmony-reflect\');\n        }\n        // hold on to all the proxies we create so that we can retrieve the handlers later\n        var unproxyMap = new WeakMap();\n        var oldProxy = Proxy;\n        // primitive values cannot be used a keys inside of a map so we\n        // need to wrap them up in a shell object that returns the original\n        // value when needed\n        function ValueShell(value) {\n            this.value = value;\n        }\n        ValueShell.prototype.valueOf = function () {\n            return this.value;\n        };\n        // @ (Any, {}, {}) -> VProxy\n        function VProxy(value, handler, key) {\n            var valueShell = new ValueShell(value);\n            var val = function (a0) {\n                    if (a0 === void 0) {\n                        return valueShell;\n                    }\n                    if (a0 === null) {\n                        return valueShell;\n                    }\n                    if (typeof a0 !== \'object\') {\n                        var x = a0;\n                        return valueShell;\n                    }\n                    return value;\n                }.call(this, value);\n            var p = new oldProxy(val, handler);\n            unproxyMap.set(p, {\n                handler: handler,\n                key: key,\n                target: val\n            });\n            return p;\n        }\n        this.Proxy = VProxy;\n        // @ (Any) -> Bool\n        function isVProxy(value) {\n            return value && typeof value === \'object\' && unproxyMap.has(value);\n        }\n        // @ (Str, Any) -> Any\n        function unary(a0, a1) {\n            if (isVProxy(a1)) {\n                var operator = a0;\n                var op = a1;\n                var target = unproxyMap.get(op).target;\n                return unproxyMap.get(op).handler.unary(target, operator, op);\n            }\n            if (a0 === \'-\') {\n                var op = a1;\n                return -op;\n            }\n            if (a0 === \'+\') {\n                var op = a1;\n                return +op;\n            }\n            if (a0 === \'++\') {\n                var op = a1;\n                return ++op;\n            }\n            if (a0 === \'--\') {\n                var op = a1;\n                return --op;\n            }\n            if (a0 === \'!\') {\n                var op = a1;\n                return !op;\n            }\n            if (a0 === \'~\') {\n                var op = a1;\n                return ~op;\n            }\n            if (a0 === \'typeof\') {\n                var op = a1;\n                return typeof op;\n            }\n            if (a0 === \'void\') {\n                var op = a1;\n                return void op;\n            }\n            throw new TypeError(\'No match\');\n        }\n        // @ (Str, Any, Any) -> Any\n        function binary(a0, a1, a2) {\n            if (isVProxy(a1)) {\n                var operator = a0;\n                var left = a1;\n                var right = a2;\n                var target = unproxyMap.get(left).target;\n                return unproxyMap.get(left).handler.left(target, operator, right);\n            }\n            if (isVProxy(a2)) {\n                var operator = a0;\n                var left = a1;\n                var right = a2;\n                var target = unproxyMap.get(right).target;\n                return unproxyMap.get(right).handler.right(target, operator, left);\n            }\n            if (a0 === \'*\') {\n                var left = a1;\n                var right = a2;\n                return left * right;\n            }\n            if (a0 === \'/\') {\n                var left = a1;\n                var right = a2;\n                return left / right;\n            }\n            if (a0 === \'%\') {\n                var left = a1;\n                var right = a2;\n                return left % right;\n            }\n            if (a0 === \'+\') {\n                var left = a1;\n                var right = a2;\n                return left + right;\n            }\n            if (a0 === \'-\') {\n                var left = a1;\n                var right = a2;\n                return left - right;\n            }\n            if (a0 === \'>>\') {\n                var left = a1;\n                var right = a2;\n                return left >> right;\n            }\n            if (a0 === \'<<\') {\n                var left = a1;\n                var right = a2;\n                return left << right;\n            }\n            if (a0 === \'>>>\') {\n                var left = a1;\n                var right = a2;\n                return left >>> right;\n            }\n            if (a0 === \'<\') {\n                var left = a1;\n                var right = a2;\n                return left < right;\n            }\n            if (a0 === \'<=\') {\n                var left = a1;\n                var right = a2;\n                return left <= right;\n            }\n            if (a0 === \'>\') {\n                var left = a1;\n                var right = a2;\n                return left > right;\n            }\n            if (a0 === \'>=\') {\n                var left = a1;\n                var right = a2;\n                return left >= right;\n            }\n            if (a0 === \'in\') {\n                var left = a1;\n                var right = a2;\n                return left in right;\n            }\n            if (a0 === \'instanceof\') {\n                var left = a1;\n                var right = a2;\n                return left instanceof right;\n            }\n            if (a0 === \'==\') {\n                var left = a1;\n                var right = a2;\n                return left == right;\n            }\n            if (a0 === \'!=\') {\n                var left = a1;\n                var right = a2;\n                return left != right;\n            }\n            if (a0 === \'===\') {\n                var left = a1;\n                var right = a2;\n                return left === right;\n            }\n            if (a0 === \'!==\') {\n                var left = a1;\n                var right = a2;\n                return left !== right;\n            }\n            if (a0 === \'&\') {\n                var left = a1;\n                var right = a2;\n                return left & right;\n            }\n            if (a0 === \'^\') {\n                var left = a1;\n                var right = a2;\n                return left ^ right;\n            }\n            if (a0 === \'|\') {\n                var left = a1;\n                var right = a2;\n                return left | right;\n            }\n            if (a0 === \'&&\') {\n                var left = a1;\n                var right = a2;\n                return left && right;\n            }\n            if (a0 === \'||\') {\n                var left = a1;\n                var right = a2;\n                return left || right;\n            }\n            throw new TypeError(\'No match\');\n        }\n        // @ (Any) -> {} or null\n        this.unproxy = function (value, key) {\n            if (isVProxy(value) && unproxyMap.get(value).key === key) {\n                return unproxyMap.get(value).handler;\n            }\n            return null;\n        };\n        return {\n            unary: unary,\n            binary: binary\n        };\n    }();';
        var expanded = sweet.compile(macroStr + '\n' + code);
        return harnessStr + '\n' + expanded.code;
    }
    return { compile: compile };
}));